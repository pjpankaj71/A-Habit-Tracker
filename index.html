<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Daily Check-In ‚Äî Habit Tracker (Telegram Mini App)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: #ffffff;--card: #f7f9fb;--text:#111827;--muted:#6b7280;
      --accent:#2ea44f;--accent-600:#24893e;--danger:#ef4444;
      --radius:12px;--max-width:800px;--shadow:0 6px 18px rgba(16,24,40,0.08);
      --glass: rgba(255,255,255,0.6);
    }
    .tg-theme-dark{
      --bg:#0f1724;--card:#0b1220;--text:#e6eef8;--muted:#9aa6bf;--accent:#1fb65e;--accent-600:#169049;--glass: rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{background:linear-gradient(180deg,var(--bg),#f3f6f9 120%);color:var(--text);display:flex;justify-content:center;padding:18px 12px;}
    .app{width:100%;max-width:var(--max-width);background:linear-gradient(180deg,var(--card),rgba(255,255,255,0.02));border-radius:18px;box-shadow:var(--shadow);padding:16px;box-sizing:border-box;}
    header{display:flex;align-items:center;gap:12px;}
    .brand{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-600));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px;}
    .title h1{margin:0;font-size:16px;}
    .title p{margin:0;color:var(--muted);font-size:12px;}
    main{margin-top:14px;}
    .top-row{display:flex;gap:8px;align-items:center;justify-content:space-between;}
    .btn{background:var(--accent);color:white;padding:10px 12px;border-radius:10px;border:0;font-weight:600;cursor:pointer;}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(17,24,39,0.06);}
    .note{font-size:12px;color:var(--muted);margin-top:10px;}
    .habits{margin-top:14px;display:flex;flex-direction:column;gap:10px;}
    .habit{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:var(--glass);}
    .icon{font-size:22px;width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(255,255,255,0.06),transparent);}
    .meta{flex:1;}
    .meta .name{font-weight:600;margin:0;}
    .meta .info{font-size:12px;color:var(--muted);margin-top:6px;}
    .actions{display:flex;gap:8px;align-items:center;}
    .small{font-size:12px;padding:8px 10px;border-radius:10px;border:0;background:transparent;color:var(--text);cursor:pointer;}
    .check-btn{background:var(--accent);color:white;border-radius:10px;padding:9px 12px;border:0;font-weight:700;cursor:pointer;}
    .check-btn[disabled]{opacity:0.5;cursor:not-allowed;background:linear-gradient(90deg,#cbd5e1,#94a3b8);color:#fff;}
    .calendar{margin-top:16px;padding:12px;border-radius:12px;background:var(--glass);display:flex;flex-direction:column;gap:10px;}
    .week-grid{display:flex;gap:8px;justify-content:space-between;}
    .day{flex:1;padding:8px;border-radius:8px;text-align:center;font-size:12px;background:rgba(0,0,0,0.03);color:var(--muted);}
    .day .dot{display:block;margin:6px auto 0;width:18px;height:18px;border-radius:50%;}
    .day.complete{background:linear-gradient(180deg,rgba(46,164,79,0.12),rgba(46,164,79,0.06));color:var(--text);}
    .day.complete .dot{background:var(--accent);}
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:80;}
    .overlay.show{display:flex;}
    .modal{width:100%;max-width:420px;background:var(--card);border-radius:14px;padding:14px;box-shadow:var(--shadow);}
    .form-row{display:flex;gap:8px;margin-top:8px;}
    input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);font-size:14px;}
    .emoji-picker{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .emoji-picker button{background:transparent;border:0;font-size:20px;padding:8px;cursor:pointer;border-radius:8px;}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:26px;background:var(--card);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);display:none;z-index:90;}
    .toast.show{display:block;}
    .flex{display:flex;gap:8px;align-items:center;}
    .danger{color:var(--danger);cursor:pointer;}
    @media (max-width:420px){.brand{width:40px;height:40px;font-size:18px}.btn{padding:9px 10px;font-size:14px;border-radius:10px}.habit{padding:10px}}
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="brand">DC</div>
      <div class="title">
        <h1>Daily Check-In</h1>
        <p>Build streaks. One tap check-ins. Data saved locally.</p>
      </div>
    </header>

    <main>
      <div class="top-row">
        <div style="display:flex;flex-direction:column">
          <div class="muted small" id="user-badge">Initializing...</div>
          <div class="small-muted" id="streak-summary">Loading your longest streak‚Ä¶</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="add-habit-btn">+ Add Habit</button>
          <button class="btn ghost" id="export-btn" title="Export your data">Export</button>
          <button class="btn ghost" id="import-btn" title="Import data">Import</button>
          <button class="btn ghost" id="daily-summary-btn" title="Daily summary">Summary</button>
          <button class="btn ghost" id="clear-data-btn" title="Clear all data (for this user)">Clear data</button>
        </div>
      </div>

      <p class="note">Note: Data saved only locally. Clearing browser data will reset progress. To get reminders, enable them via your bot (e.g., send <code>/remind</code>).</p>

      <section class="habits" id="habits-list">
        <!-- Habit cards inserted here -->
      </section>

      <section class="calendar" aria-label="Weekly overview">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Weekly Overview</strong>
          <div class="muted small">Green = at least one habit completed</div>
        </div>
        <div class="week-grid" id="week-grid"></div>
      </section>
    </main>
  </div>

  <!-- Modal / Add / Edit -->
  <div class="overlay" id="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal" id="modal">
      <h3 id="modal-title">Add Habit</h3>
      <div class="form-row">
        <input type="text" id="habit-name" placeholder="Habit name (e.g., Code 30 min)" maxlength="60" />
      </div>
      <div class="emoji-picker" id="emoji-picker">
        <button data-emoji="üíß">üíß</button><button data-emoji="üßò">üßò</button><button data-emoji="üíª">üíª</button>
        <button data-emoji="üèÉ">üèÉ</button><button data-emoji="üìö">üìö</button><button data-emoji="üõå">üõå</button>
        <button data-emoji="üçé">üçé</button><button data-emoji="üéß">üéß</button><button data-emoji="‚úçÔ∏è">‚úçÔ∏è</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;align-items:center;">
        <input type="text" id="selected-emoji" placeholder="Choose emoji or type" style="width:72px;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);font-size:18px;text-align:center;" />
        <div style="flex:1"></div>
        <button class="btn" id="save-habit-btn">Save</button>
        <button class="btn ghost" id="cancel-habit-btn">Cancel</button>
      </div>
      <div class="small-muted" style="margin-top:10px">Tip: keep habits short and specific for best streaks.</div>
    </div>
  </div>

  <!-- Import Modal -->
  <div class="overlay" id="import-overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Import Data</h3>
      <p class="muted">Paste exported JSON or choose file</p>
      <textarea id="import-text" style="width:100%;height:120px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);padding:8px"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <input type="file" id="import-file" accept=".json" />
        <button class="btn" id="import-apply-btn">Import</button>
        <button class="btn ghost" id="import-cancel-btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Daily Summary modal -->
  <div class="overlay" id="summary-overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Today's Summary</h3>
      <div id="summary-content" style="min-height:80px"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn" id="summary-copy-btn">Copy Summary</button>
        <button class="btn ghost" id="summary-close-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">Great job! üéâ</div>

  <script>
    // ---------- Helpers ----------
    function toYMD(d = new Date()) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }
    function ymdToDate(str) {
      const [y,m,d] = str.split('-').map(Number);
      return new Date(y, m-1, d);
    }

    const STORAGE_KEY = 'daily-checkin:v1';
    const WebApp = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    let userId = null;
    let isTelegram = !!WebApp;

    function initTelegram() {
      if (WebApp) {
        try {
          WebApp.ready && WebApp.ready();
          WebApp.expand && WebApp.expand();
          if (WebApp.colorScheme === 'dark') document.body.classList.add('tg-theme-dark'); else document.body.classList.remove('tg-theme-dark');
          const initUnsafe = WebApp.initDataUnsafe || {};
          if (initUnsafe.user && initUnsafe.user.id) userId = String(initUnsafe.user.id); else userId = 'tg_unknown_' + (Date.now()%10000);
        } catch (e) {
          console.warn('Telegram init error', e); userId = 'tg_demo_' + (Date.now()%10000);
        }
      } else {
        userId = 'demo_user';
        document.body.classList.remove('tg-theme-dark');
      }
    }

    function readAll() {
      try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : {}; } catch(e){ console.error(e); return {}; }
    }
    function writeAll(obj) { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); } catch(e){ console.error(e); } }
    function loadUserData() {
      const all = readAll();
      if (!all[userId]) { all[userId] = { habits: [] }; writeAll(all); return all[userId]; }
      return all[userId];
    }
    function saveUserData(data) { const all = readAll(); all[userId] = data; writeAll(all); }
    function clearUserData() { const all = readAll(); delete all[userId]; writeAll(all); }

    function genId(prefix='h') { return prefix + Math.random().toString(36).slice(2,9); }

    function computeCurrentStreak(completions) {
      const set = new Set(completions || []);
      let cnt = 0;
      let cursor = toYMD();
      if (!set.has(cursor)) { const dt = new Date(); dt.setDate(dt.getDate() - 1); cursor = toYMD(dt); }
      while (set.has(cursor)) { cnt++; const dt = ymdToDate(cursor); dt.setDate(dt.getDate() - 1); cursor = toYMD(dt); }
      return cnt;
    }
    function computeLongestStreak(completions) {
      if (!completions || completions.length === 0) return 0;
      const arr = Array.from(new Set(completions)).sort();
      let longest = 0, current = 0, prev = null;
      arr.forEach(dateStr => {
        if (!prev) current = 1; else {
          const diff = Math.round((ymdToDate(dateStr) - ymdToDate(prev)) / (1000*60*60*24));
          if (diff === 1) current++; else current = 1;
        }
        if (current > longest) longest = current;
        prev = dateStr;
      });
      return longest;
    }

    // ---------- DOM elements ----------
    const habitsListEl = document.getElementById('habits-list');
    const weekGridEl = document.getElementById('week-grid');
    const userBadgeEl = document.getElementById('user-badge');
    const streakSummaryEl = document.getElementById('streak-summary');
    const toastEl = document.getElementById('toast');

    let userData = null;

    function showToast(text = 'Great job! üéâ', ms = 1400) {
      toastEl.textContent = text; toastEl.classList.add('show'); setTimeout(()=> toastEl.classList.remove('show'), ms);
    }
    function vibrateSuccess() {
      try { if (WebApp && WebApp.HapticFeedback) { WebApp.HapticFeedback.notificationSuccess && WebApp.HapticFeedback.notificationSuccess(); } else if (navigator.vibrate) navigator.vibrate(60); } catch(e){}
    }

    // render habits sorted by current streak desc
    function renderHabits() {
      habitsListEl.innerHTML = '';
      const list = (userData.habits || []).slice();
      // compute current streaks and sort
      list.forEach(h => { h._cur = computeCurrentStreak(h.completions || []); });
      list.sort((a,b) => b._cur - a._cur || (a.name || '').localeCompare(b.name));
      if (list.length === 0) {
        const note = document.createElement('div'); note.className = 'muted'; note.style.marginTop='8px'; note.textContent = 'No habits yet. Add one to start tracking your streaks!'; habitsListEl.appendChild(note); renderWeekGrid(); updateStreakSummary(); return;
      }
      list.forEach(habit => {
        const card = document.createElement('div'); card.className = 'habit';
        const icon = document.createElement('div'); icon.className='icon'; icon.textContent = habit.icon || 'üîñ';
        const meta = document.createElement('div'); meta.className='meta';
        const name = document.createElement('div'); name.className='name'; name.textContent = habit.name;
        const completions = habit.completions || [];
        const current = computeCurrentStreak(completions);
        const longest = computeLongestStreak(completions);
        const info = document.createElement('div'); info.className='info'; info.innerHTML = `<span class="muted">Created ${habit.createdAt}</span> ¬∑ <strong>üî• ${current}-day</strong> ¬∑ Longest: ${longest}`;
        meta.appendChild(name); meta.appendChild(info);
        const actions = document.createElement('div'); actions.className='actions';
        const today = toYMD(); const checkedToday = completions.includes(today);
        const checkBtn = document.createElement('button'); checkBtn.className='check-btn'; checkBtn.textContent = checkedToday ? 'Checked' : 'Check In'; checkBtn.disabled = checkedToday;
        checkBtn.onclick = () => { if (checkBtn.disabled) return; habit.completions = Array.from(new Set([...(habit.completions||[]), today])); saveUserData(userData); renderHabits(); renderWeekGrid(); showToast('Great job! üéâ'); vibrateSuccess(); updateStreakSummary(); };
        const editBtn = document.createElement('button'); editBtn.className='small'; editBtn.textContent='Edit'; editBtn.onclick = () => openHabitModal('edit', habit.id);
        const delBtn = document.createElement('button'); delBtn.className='small danger'; delBtn.textContent='Delete'; delBtn.onclick = () => {
          if (!confirm('Delete this habit and its history?')) return;
          userData.habits = userData.habits.filter(x => x.id !== habit.id); saveUserData(userData); renderHabits(); renderWeekGrid(); updateStreakSummary();
        };
        actions.appendChild(checkBtn); actions.appendChild(editBtn); actions.appendChild(delBtn);
        card.appendChild(icon); card.appendChild(meta); card.appendChild(actions); habitsListEl.appendChild(card);
      });
      updateStreakSummary();
    }

    // weekly grid displaying past 7 days (Mon-Sun depends on locale)
    function renderWeekGrid() {
      weekGridEl.innerHTML = '';
      const days = []; for(let i=6;i>=0;i--){ const dt=new Date(); dt.setDate(dt.getDate()-i); days.push(dt); }
      days.forEach(dt => {
        const ymd = toYMD(dt); let count = 0; (userData.habits||[]).forEach(h=>{ if((h.completions||[]).includes(ymd)) count++; });
        const dayEl = document.createElement('div'); dayEl.className = 'day' + (count>0 ? ' complete' : '');
        const weekday = dt.toLocaleDateString(undefined, { weekday: 'short' });
        const dayNum = dt.getDate();
        dayEl.innerHTML = `<div style="font-weight:700">${weekday}</div><div style="font-size:14px;margin-top:6px">${dayNum}</div><div class="dot" aria-hidden="true"></div><div class="count">${count>0?count+' habit(s)':''}</div>`;
        weekGridEl.appendChild(dayEl);
      });
    }

    function updateStreakSummary() {
      if (isTelegram) userBadgeEl.textContent = 'Telegram User: ' + userId; else userBadgeEl.innerHTML = 'Demo mode ‚Äî open via Telegram to use real account';
      let globalLongest = 0; (userData.habits||[]).forEach(h => { const l = computeLongestStreak(h.completions||[]); if (l>globalLongest) globalLongest=l; });
      streakSummaryEl.textContent = `Longest streak across habits: ${globalLongest} day(s)`;
    }

    // ---------- Modal logic ----------
    const overlay = document.getElementById('modal-overlay');
    const modalTitle = document.getElementById('modal-title');
    const habitNameInput = document.getElementById('habit-name');
    const emojiPicker = document.getElementById('emoji-picker');
    const selectedEmojiInput = document.getElementById('selected-emoji');
    const saveHabitBtn = document.getElementById('save-habit-btn');
    const cancelHabitBtn = document.getElementById('cancel-habit-btn');
    let modalMode = 'add'; let editingId = null;

    document.getElementById('add-habit-btn').addEventListener('click', ()=> openHabitModal('add'));
    cancelHabitBtn.addEventListener('click', closeHabitModal);

    emojiPicker.addEventListener('click', (e)=>{ const btn = e.target.closest('button[data-emoji]'); if (!btn) return; selectedEmojiInput.value = btn.dataset.emoji; });

    function openHabitModal(mode='add', id=null) {
      modalMode = mode; editingId = id;
      if (mode === 'add') { modalTitle.textContent='Add Habit'; habitNameInput.value=''; selectedEmojiInput.value=''; }
      else { modalTitle.textContent='Edit Habit'; const h = (userData.habits||[]).find(x=>x.id===id); if(!h) return alert('Habit not found'); habitNameInput.value=h.name; selectedEmojiInput.value=h.icon||''; }
      overlay.classList.add('show'); habitNameInput.focus();
    }
    function closeHabitModal(){ overlay.classList.remove('show'); editingId=null; }

    saveHabitBtn.addEventListener('click', ()=> {
      const name = habitNameInput.value.trim(); const icon = selectedEmojiInput.value.trim() || 'üîñ';
      if (!name) return alert('Please enter a habit name.');
      if (modalMode === 'add') {
        userData.habits.push({ id: genId('h'), name, icon, createdAt: toYMD(), completions: [] });
      } else {
        const h = userData.habits.find(x=>x.id===editingId); if(!h) return alert('Habit not found'); h.name=name; h.icon=icon;
      }
      saveUserData(userData); closeHabitModal(); renderHabits(); renderWeekGrid();
    });
    overlay.addEventListener('click', (e)=> { if (e.target === overlay) closeHabitModal(); });

    // ---------- Export / Import ----------
    const exportBtn = document.getElementById('export-btn');
    const importBtn = document.getElementById('import-btn');
    const importOverlay = document.getElementById('import-overlay');
    const importApplyBtn = document.getElementById('import-apply-btn');
    const importCancelBtn = document.getElementById('import-cancel-btn');
    const importText = document.getElementById('import-text');
    const importFile = document.getElementById('import-file');

    exportBtn.addEventListener('click', ()=> {
      const all = readAll();
      const blob = new Blob([JSON.stringify(all, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = `daily-checkin-export-${userId}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', ()=> { importOverlay.classList.add('show'); importText.value = ''; importFile.value = ''; importText.focus(); });
    importCancelBtn.addEventListener('click', ()=> importOverlay.classList.remove('show'));
    importApplyBtn.addEventListener('click', ()=> {
      let raw = importText.value.trim();
      if (!raw && importFile.files && importFile.files.length > 0) {
        const f = importFile.files[0]; const reader = new FileReader(); reader.onload = e => { raw = e.target.result; applyImport(raw); }; reader.readAsText(f); return;
      }
      applyImport(raw);
    });

    function applyImport(raw) {
      if (!raw) return alert('Paste JSON or choose a file to import.');
      try {
        const parsed = JSON.parse(raw);
        // optional: merge or overwrite - we overwrite for simplicity
        writeAll(parsed);
        userData = loadUserData();
        renderHabits(); renderWeekGrid(); updateStreakSummary();
        importOverlay.classList.remove('show');
        alert('Import successful.');
      } catch(e) { alert('Invalid JSON.'); }
    }

    // ---------- Daily Summary ----------
    const summaryBtn = document.getElementById('daily-summary-btn');
    const summaryOverlay = document.getElementById('summary-overlay');
    const summaryContent = document.getElementById('summary-content');
    const summaryCopyBtn = document.getElementById('summary-copy-btn');
    const summaryCloseBtn = document.getElementById('summary-close-btn');

    summaryBtn.addEventListener('click', ()=> openSummary());
    summaryCloseBtn.addEventListener('click', ()=> summaryOverlay.classList.remove('show'));
    summaryCopyBtn.addEventListener('click', ()=> {
      const text = summaryContent.innerText;
      navigator.clipboard && navigator.clipboard.writeText(text).then(()=> showToast('Summary copied to clipboard'), ()=> alert('Copy failed.'));
    });

    function openSummary() {
      const today = toYMD();
      const totalHabits = (userData.habits||[]).length;
      let completed = 0; let list = '';
      (userData.habits||[]).forEach(h => { if ((h.completions||[]).includes(today)) { completed++; list += `- ${h.icon || ''} ${h.name} (checked)\n`; } else { list += `- ${h.icon || ''} ${h.name} (not checked)\n`; } });
      const summaryText = `Daily Check-In Summary (${today})\nCompleted: ${completed}/${totalHabits}\n\n${list}\nKeep going! üî•`;
      summaryContent.innerText = summaryText;
      summaryOverlay.classList.add('show');
    }

    // ---------- Clear data ----------
    document.getElementById('clear-data-btn').addEventListener('click', ()=> {
      if (!confirm('Clear all stored data for this user? This cannot be undone.')) return;
      clearUserData();
      userData = loadUserData();
      renderHabits(); renderWeekGrid(); updateStreakSummary();
      alert('Data cleared for this user.');
    });

    // ---------- Boot ----------
    function boot() {
      initTelegram();
      userData = loadUserData();
      renderHabits(); renderWeekGrid(); updateStreakSummary();
      if (!isTelegram) {
        const p = document.createElement('p'); p.className='muted'; p.style.marginTop='10px'; p.innerHTML='Tip: This app detects Telegram WebApp when opened from a bot. For full experience open via your Telegram bot.'; document.querySelector('main').prepend(p);
      } else {
        try { if (WebApp.MainButton) { WebApp.MainButton.setText && WebApp.MainButton.setText('Open Daily Check-In'); WebApp.MainButton.show && WebApp.MainButton.show(); } } catch(e){}
      }
    }

    boot();
  </script>
</body>
</html>
