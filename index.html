<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Daily Check-In ‚Äî Habit Tracker (Telegram Mini App)</title>

  <!-- Telegram Web App SDK (required by the app) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* ---------- CSS Variables & Theme ---------- */
    :root{
      --bg: #f7fbff;
      --card: #ffffff;
      --text: #0f1724;
      --muted: #516074;
      --accent: #2a9df4; /* telegram-blue-friendly */
      --accent-contrast: #ffffff;
      --success: #18a06b;
      --danger: #e05555;
      --glass: rgba(255,255,255,0.6);
      --radius: 14px;
      --gap: 12px;
      --maxw: 800px;
    }

    .tg-theme-dark {
      --bg: #0b1220;
      --card: #0f1724;
      --text: #e6eef8;
      --muted: #9fb0c8;
      --accent: #2a9df4;
      --accent-contrast: #071826;
      --glass: rgba(6,10,15,0.45);
    }

    /* ---------- Base layout ---------- */
    html,body{
      height:100%;
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, var(--bg), rgba(0,0,0,0));
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .app {
      max-width:var(--maxw);
      margin: 14px auto;
      padding: 14px;
      box-sizing:border-box;
    }

    header{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }

    .brand {
      display:flex;
      gap:12px;
      align-items:center;
    }

    .logo {
      height:48px;
      width:48px;
      border-radius:12px;
      display:inline-grid;
      place-items:center;
      font-weight:700;
      background:linear-gradient(135deg,var(--accent), #3fc0ff);
      color:var(--accent-contrast);
      box-shadow: 0 6px 18px rgba(42,157,244,0.12);
      border-radius:12px;
    }

    h1{
      font-size:18px;
      margin:0;
      letter-spacing: -0.2px;
    }

    p.lead {
      margin:0;
      color:var(--muted);
      font-size:13px;
    }

    .controls {
      display:flex;
      gap:8px;
      align-items:center;
    }

    button.btn {
      border:0;
      background:var(--accent);
      color:var(--accent-contrast);
      padding:8px 12px;
      border-radius:10px;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      box-shadow: 0 6px 14px rgba(42,157,244,0.12);
    }
    button.ghost{
      background:transparent;
      color:var(--text);
      border:1px solid rgba(0,0,0,0.06);
      box-shadow:none;
    }

    /* ---------- Layout columns ---------- */
    main {
      display:grid;
      gap:12px;
      grid-template-columns: 1fr;
    }

    .card {
      background:var(--card);
      padding:12px;
      border-radius:var(--radius);
      box-shadow: 0 6px 18px rgba(2,6,23,0.06);
    }

    /* ---------- Habit list ---------- */
    .habit-list {
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .habit {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:10px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    }

    .left {
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }

    .habit-icon{
      width:56px;
      height:56px;
      border-radius:12px;
      display:grid;
      place-items:center;
      font-size:24px;
      background:var(--glass);
      color:var(--text);
      flex-shrink:0;
    }

    .habit-meta {
      min-width:0;
    }

    .habit-meta h3{
      margin:0;
      font-size:15px;
      font-weight:700;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }
    .habit-meta p{
      margin:2px 0 0 0;
      font-size:12px;
      color:var(--muted);
    }

    .right {
      display:flex;
      gap:8px;
      align-items:center;
    }

    .streak {
      background: linear-gradient(90deg, rgba(255,215,87,0.12), rgba(255,126,95,0.06));
      padding:6px 8px;
      border-radius:10px;
      font-weight:700;
      color:var(--text);
      font-size:13px;
    }

    .check-btn {
      border-radius:10px;
      padding:8px 12px;
      border:0;
      background:var(--success);
      color:white;
      font-weight:700;
      cursor:pointer;
    }
    .check-btn[disabled]{
      opacity:0.45;
      cursor:not-allowed;
    }

    .icon-btn {
      border:0;
      background:transparent;
      font-size:16px;
      cursor:pointer;
      padding:6px;
      border-radius:8px;
      color:var(--muted);
    }

    /* ---------- Add form (modal-like) ---------- */
    .add-form {
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    input[type="text"], select {
      padding:10px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.06);
      min-width:0;
      flex:1 1 auto;
      font-size:14px;
      background:transparent;
      color:var(--text);
    }

    .emoji-picker {
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .emoji-picker button {
      padding:6px;
      border-radius:8px;
      border:1px solid rgba(0,0,0,0.04);
      cursor:pointer;
      background:transparent;
      font-size:18px;
    }

    /* ---------- Weekly calendar ---------- */
    .week-grid {
      display:grid;
      grid-template-columns: repeat(7,1fr);
      gap:8px;
    }

    .day {
      padding:8px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      text-align:center;
      font-size:12px;
    }

    .day .dot {
      width:18px;
      height:18px;
      border-radius:999px;
      margin:6px auto 0 auto;
      background:#cbd5e1;
    }
    .day.done .dot { background: var(--success); box-shadow: 0 4px 10px rgba(24,160,107,0.18); }
    .day .count { font-size:11px; color:var(--muted); margin-top:4px; }

    /* ---------- Toast ---------- */
    #toast {
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:24px;
      background: #111827;
      color:white;
      padding:10px 14px;
      border-radius:999px;
      display:none;
      z-index:9999;
      font-weight:700;
    }

    /* ---------- Footer / small print ---------- */
    .muted {
      font-size:12px;
      color:var(--muted);
    }

    /* Responsive adjustments */
    @media (min-width:540px){
      main { grid-template-columns: 1fr 320px; align-items:start; }
    }
  </style>
</head>
<body>
  <div id="toast" role="status" aria-live="polite"></div>

  <div class="app" id="app">
    <header>
      <div class="brand">
        <div class="logo">DC</div>
        <div>
          <h1>Daily Check-In</h1>
          <p class="lead">Build habits, track streaks ‚Äî data saved locally in your browser.</p>
        </div>
      </div>

      <div class="controls">
        <button id="btnAdd" class="btn">+ Add Habit</button>
        <button id="btnClear" class="ghost">Clear data</button>
      </div>
    </header>

    <main>
      <!-- Left column: habit list -->
      <section class="card" id="leftCol">
        <h3 style="margin-top:0;">Your Habits</h3>
        <div id="noHabits" class="muted">No habits yet ‚Äî add one using the <strong>Add Habit</strong> button.</div>
        <div class="habit-list" id="habitList" aria-live="polite"></div>
        <div style="margin-top:10px;" class="muted">Note: Data saved locally & scoped to your Telegram user ID. Clearing browser data will reset progress.</div>
      </section>

      <!-- Right column: add form + weekly calendar -->
      <aside class="card" id="rightCol">
        <div id="addSection">
          <h4 style="margin:0 0 8px 0;">Add / Edit Habit</h4>
          <form id="habitForm" class="add-form" onsubmit="return false;">
            <input id="habitName" type="text" placeholder="Habit name (e.g., 'Read 20 min')" required />
            <input id="habitIdHidden" type="hidden" value="" />
            <button id="saveHabitBtn" class="btn" type="submit">Save</button>
          </form>

          <div class="emoji-picker" id="emojiPicker" aria-hidden="false">
            <!-- Emoji choices -->
            <button data-emoji="üíß">üíß</button>
            <button data-emoji="üßò">üßò</button>
            <button data-emoji="üíª">üíª</button>
            <button data-emoji="üèÉ">üèÉ</button>
            <button data-emoji="üìö">üìö</button>
            <button data-emoji="üõå">üõå</button>
            <button data-emoji="üçé">üçé</button>
            <button data-emoji="‚úçÔ∏è">‚úçÔ∏è</button>
            <button data-emoji="üîî">üîî</button>
          </div>
          <div style="margin-top:10px;" id="globalStats" class="muted"></div>
        </div>

        <hr style="opacity:0.06;margin:12px 0;" />

        <div>
          <h4 style="margin:0 0 8px 0;">Weekly Overview</h4>
          <div class="week-grid" id="weekGrid" aria-live="polite"></div>
        </div>
      </aside>
    </main>
  </div>

  <script>
/* ==========================================
   Daily Check-In ‚Äî Vanilla JS (single file)
   - Uses window.Telegram.WebApp when available.
   - Stores everything in localStorage under key: daily-checkin:data
   - Data scope: per Telegram user id (WebApp.initDataUnsafe.user.id) OR fallback 'local_guest'
   ========================================== */

  // ================== Helpers: date formatting ==================
  const toYMD = (d) => {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  };

  const parseYMD = (s) => {
    // s is "YYYY-MM-DD"
    const [y,m,d] = s.split('-').map(Number);
    return new Date(y, m-1, d);
  };

  const addDays = (d, days) => {
    const x = new Date(d);
    x.setDate(x.getDate() + days);
    return x;
  };

  // ================== Storage keys & data helpers ==================
  const STORAGE_KEY = 'daily-checkin:data';
  let rawStorage = {}; // entire payload mapping userId => userData
  let currentUserId = null;
  let telegramWebApp = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

  function loadRawStorage(){
    try{
      const str = localStorage.getItem(STORAGE_KEY);
      rawStorage = str ? JSON.parse(str) : {};
    }catch(e){
      console.error('Failed to load storage', e);
      rawStorage = {};
    }
  }

  function saveRawStorage(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(rawStorage));
    }catch(e){
      console.error('Failed to save', e);
    }
  }

  function ensureUserData(userId){
    if(!rawStorage[userId]) {
      rawStorage[userId] = { habits: [] };
    }
    return rawStorage[userId];
  }

  // ================== Utilities: ids & toasts ==================
  function makeId(){
    return String(Date.now().toString(36) + Math.random().toString(36).slice(2,7));
  }

  function showToast(msg, ms = 1400){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.display = 'block';
    t.style.opacity = '1';
    setTimeout(()=> {
      t.style.transition = 'opacity 300ms';
      t.style.opacity = '0';
      setTimeout(()=> t.style.display = 'none', 320);
    }, ms);
  }

  // ================== Telegram helpers (safe checks) ==================
  function telegramReadySafely(){
    if(telegramWebApp && typeof telegramWebApp.ready === 'function'){
      try{ telegramWebApp.ready(); }catch(e){}
    }
  }
  function telegramExpandSafely(){
    if(telegramWebApp && typeof telegramWebApp.expand === 'function'){
      try{ telegramWebApp.expand(); }catch(e){}
    }
  }
  function telegramHaptic(type='light'){
    // Use safest available API ‚Äî modern SDKs expose HapticFeedback but implementation differs.
    try{
      // new SDK: WebApp.HapticFeedback.* style -> check presence
      if(telegramWebApp && telegramWebApp.HapticFeedback && telegramWebApp.HapticFeedback.impactOccurred && typeof telegramWebApp.HapticFeedback.impactOccurred === 'function'){
        telegramWebApp.HapticFeedback.impactOccurred(type);
        return;
      }
      // fallback: older/other SDKs may provide hapticFeedback.* functions
      if(telegramWebApp && telegramWebApp.hapticFeedback && telegramWebApp.hapticFeedback.impactOccurred && typeof telegramWebApp.hapticFeedback.impactOccurred === 'function'){
        telegramWebApp.hapticFeedback.impactOccurred(type);
        return;
      }
      // no-op if not available
    }catch(e){ console.warn('Haptic call failed', e); }
  }

  // ================== Streak Calculations ==================
  function currentStreakFor(habit){
    // completions: array of YYYY-MM-DD
    const set = new Set(habit.completions || []);
    let streak = 0;
    let day = new Date(); // today local
    while(true){
      const dayStr = toYMD(day);
      if(set.has(dayStr)){
        streak++;
        day = addDays(day, -1);
      } else break;
    }
    return streak;
  }

  function longestStreakFor(habit){
    // find the maximum consecutive run in completions array
    const arr = (habit.completions || []).slice().sort(); // lexicographic works for YYYY-MM-DD
    if(arr.length === 0) return 0;
    let maxStreak = 1;
    let curStreak = 1;
    for(let i=1;i<arr.length;i++){
      const prev = parseYMD(arr[i-1]);
      const cur = parseYMD(arr[i]);
      const diff = Math.round((cur - prev)/(1000*60*60*24));
      if(diff === 1) {
        curStreak++;
      } else if(diff === 0) {
        // same day duplicate: ignore
      } else {
        if(curStreak > maxStreak) maxStreak = curStreak;
        curStreak = 1;
      }
    }
    if(curStreak > maxStreak) maxStreak = curStreak;
    return maxStreak;
  }

  // ================== UI Rendering ==================
  function renderHabits(){
    const userData = ensureUserData(currentUserId);
    const list = document.getElementById('habitList');
    list.innerHTML = '';
    if(!userData.habits.length){
      document.getElementById('noHabits').style.display = 'block';
    } else {
      document.getElementById('noHabits').style.display = 'none';
    }

    for(const h of userData.habits.slice().reverse()){
      const el = document.createElement('div');
      el.className = 'habit';
      el.setAttribute('data-id', h.id);

      const left = document.createElement('div'); left.className='left';
      const icon = document.createElement('div'); icon.className='habit-icon'; icon.textContent = h.icon || 'üîñ';
      const meta = document.createElement('div'); meta.className='habit-meta';
      const title = document.createElement('h3'); title.textContent = h.name || '(no name)';
      const sub = document.createElement('p'); sub.textContent = `Created ${h.createdAt} ¬∑ ${h.completions?.length || 0} checks`;

      meta.appendChild(title); meta.appendChild(sub);
      left.appendChild(icon); left.appendChild(meta);

      const right = document.createElement('div'); right.className='right';
      const streakEl = document.createElement('div'); streakEl.className='streak';
      streakEl.textContent = `üî• ${currentStreakFor(h)} ‚Ä¢ üìà ${longestStreakFor(h)}`;

      const btnCheck = document.createElement('button');
      btnCheck.className = 'check-btn';
      btnCheck.textContent = 'Check In';
      const todayStr = toYMD(new Date());
      if((h.completions || []).includes(todayStr)){
        btnCheck.disabled = true;
        btnCheck.textContent = 'Done';
      }
      btnCheck.addEventListener('click', () => {
        handleCheckIn(h.id);
      });

      const editBtn = document.createElement('button');
      editBtn.className = 'icon-btn';
      editBtn.title = 'Edit';
      editBtn.innerHTML = '‚úèÔ∏è';
      editBtn.addEventListener('click', ()=> openEdit(h.id));

      const delBtn = document.createElement('button');
      delBtn.className = 'icon-btn';
      delBtn.title = 'Delete';
      delBtn.innerHTML = 'üóëÔ∏è';
      delBtn.addEventListener('click', ()=> {
        if(confirm('Delete this habit? This will remove completions too.')) {
          deleteHabit(h.id);
        }
      });

      right.appendChild(streakEl);
      right.appendChild(btnCheck);
      right.appendChild(editBtn);
      right.appendChild(delBtn);

      el.appendChild(left);
      el.appendChild(right);
      list.appendChild(el);
    }

    renderGlobalStats();
    renderWeek();
  }

  function renderGlobalStats(){
    const userData = ensureUserData(currentUserId);
    const all = userData.habits || [];
    const longestAll = all.reduce((acc,h)=> Math.max(acc, longestStreakFor(h)), 0);
    const totalHabits = all.length;
    document.getElementById('globalStats').textContent = `Total habits: ${totalHabits} ¬∑ Longest streak (any habit): ${longestAll} days`;
  }

  // Week grid: Sun -> Sat of current week
  function renderWeek(){
    const grid = document.getElementById('weekGrid');
    grid.innerHTML = '';
    const userData = ensureUserData(currentUserId);
    const habits = userData.habits || [];

    // find Sunday of this week (local)
    const today = new Date();
    const dow = today.getDay(); // 0 = Sun
    const sunday = addDays(today, -dow);

    for(let i=0;i<7;i++){
      const d = addDays(sunday, i);
      const dStr = toYMD(d);
      const dayLabel = d.toLocaleDateString(undefined, {weekday:'short'}); // e.g., Sun
      const count = habits.reduce((acc,h) => acc + ((h.completions || []).includes(dStr) ? 1 : 0), 0);
      const el = document.createElement('div');
      el.className = 'day' + (count>0 ? ' done' : '');
      el.innerHTML = `<div style="font-weight:700">${dayLabel}</div><div style="font-size:12px;margin-top:4px;">${dStr}</div><div class="dot" aria-hidden="true"></div><div class="count">${count} done</div>`;
      grid.appendChild(el);
    }
  }

  // ================== Actions (add/edit/delete/check-in) ==================
  function addHabit(name, icon){
    const userData = ensureUserData(currentUserId);
    const newH = {
      id: makeId(),
      name: name,
      icon: icon || 'üîñ',
      createdAt: toYMD(new Date()),
      completions: []
    };
    userData.habits.push(newH);
    saveRawStorage();
    renderHabits();
  }

  function openEdit(habitId){
    const userData = ensureUserData(currentUserId);
    const h = userData.habits.find(x=>x.id===habitId);
    if(!h) return;
    document.getElementById('habitName').value = h.name;
    document.getElementById('habitIdHidden').value = h.id;
    // preselect emoji visually by highlighting (light approach)
    showToast('Editing habit ‚Äî press Save', 1200);
    window.scrollTo({top:0,behavior:'smooth'});
  }

  function saveFromForm(){
    const name = document.getElementById('habitName').value.trim();
    const hid = document.getElementById('habitIdHidden').value;
    const picked = document.querySelector('.emoji-picker button.selected');
    const icon = picked ? picked.dataset.emoji : (document.querySelector('.emoji-picker button')?.dataset?.emoji || 'üîñ');

    if(!name) return alert('Please enter a habit name.');

    const userData = ensureUserData(currentUserId);

    if(hid){
      // edit
      const h = userData.habits.find(x=>x.id===hid);
      if(h){
        h.name = name;
        h.icon = icon;
        saveRawStorage();
        document.getElementById('habitIdHidden').value = '';
        document.getElementById('habitName').value = '';
        document.querySelectorAll('.emoji-picker button').forEach(b=>b.classList.remove('selected'));
        renderHabits();
        showToast('Habit updated');
        return;
      }
    }
    // add new
    addHabit(name, icon);
    document.getElementById('habitName').value = '';
    document.querySelectorAll('.emoji-picker button').forEach(b=>b.classList.remove('selected'));
    showToast('Habit added üéâ');
  }

  function deleteHabit(habitId){
    const userData = ensureUserData(currentUserId);
    userData.habits = userData.habits.filter(h=>h.id !== habitId);
    saveRawStorage();
    renderHabits();
  }

  function handleCheckIn(habitId){
    const userData = ensureUserData(currentUserId);
    const h = userData.habits.find(x=>x.id===habitId);
    if(!h) return;
    const today = toYMD(new Date());
    if(!h.completions) h.completions = [];
    if(h.completions.includes(today)) {
      showToast('Already checked in today');
      return;
    }
    h.completions.push(today);
    // remove duplicates and sort
    h.completions = Array.from(new Set(h.completions)).sort();
    saveRawStorage();
    renderHabits();
    // haptic & toast
    telegramHaptic('light');
    showToast('Great job! üéâ', 1600);
  }

  // Clear all data for current user (dangerous, used for testing)
  function clearUserData(){
    if(!confirm('Clear all local data for this user? This cannot be undone.')) return;
    rawStorage[currentUserId] = { habits: [] };
    saveRawStorage();
    renderHabits();
    showToast('Data cleared');
  }

  // ================== Init & bindings ==================
  function initApp(){
    loadRawStorage();

    // Determine current user ID from Telegram WebApp if possible
    if(telegramWebApp && telegramWebApp.initDataUnsafe && telegramWebApp.initDataUnsafe.user && telegramWebApp.initDataUnsafe.user.id){
      currentUserId = 'tg:' + telegramWebApp.initDataUnsafe.user.id; // prefix to avoid collisions
    } else {
      // fallback for local testing outside Telegram
      currentUserId = 'local_guest';
    }
    ensureUserData(currentUserId);
    // UI theme from Telegram
    if(telegramWebApp && telegramWebApp.colorScheme === 'dark'){
      document.documentElement.classList.add('tg-theme-dark');
    }

    // Try to tell Telegram we're ready and expand
    telegramReadySafely();
    telegramExpandSafely();

    // Bind add form
    const btnAdd = document.getElementById('btnAdd');
    btnAdd.addEventListener('click', ()=> {
      document.getElementById('habitName').focus();
      showToast('Type a name, pick an emoji, press Save');
    });

    document.getElementById('habitForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      saveFromForm();
    });

    // Emoji picker click
    document.querySelectorAll('.emoji-picker button').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        document.querySelectorAll('.emoji-picker button').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
      });
    });

    document.getElementById('btnClear').addEventListener('click', ()=> {
      clearUserData();
    });

    // Render initial UI
    renderHabits();
  }

  // Run init after DOM loaded
  document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
